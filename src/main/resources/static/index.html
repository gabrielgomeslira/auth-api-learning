<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tasks</title>
</head>
<body>

<input type="hidden" id="taskIdUser">
<span>User: <span id="LoginUsername"></span></span>
<span>$: <span id="userBalance"></span></span>

<h1>create user</h1>
<input type="text" id="create_username" placeholder="username">
<input type="text" id="create_password" placeholder="password">
<button onclick="createUser()">Create</button>

<h1>login</h1>
<input type="text" id="username" placeholder="username">
<input type="text" id="password" placeholder="password">
<button onclick="loginUser()">Login</button>
<p id="loginError" style="color: red; margin-top: 10px;"></p>

<h1>task create</h1>
<input type="input" id="taskName" placeholder="Nome da task">
<button onclick="createTask()">Criar task</button>

<h1>tasklist</h1>
<ul id="taskList"></ul>

<script>
    const apiUrl = "http://localhost:8080";

    function getTasks() {
        const taskIdUser = document.getElementById("taskIdUser").value;
        fetch(apiUrl + "/task/list/user?userId=" + taskIdUser)
            .then(response => response.json())
            .then(data => {
                let taskList = document.getElementById("taskList");
                taskList.innerHTML = "";
                data.forEach(task => {
                    taskList.innerHTML += `
                        <li>
                            <input value="${task.status}" ${task.status ? 'checked' : ''} type="checkbox" onclick="completedTask(${task.id})"></input>
                            ${task.description}
                            ${task.value}
                            <button onclick="deleteTask(${task.id})">Excluir</button>
                        </li>
                    `;
                });
            })
            .catch(error => console.error("Erro when try to search for tasks:", error));
    }

    function loginUser() {
        document.getElementById("loginError").textContent = "";

        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        fetch(apiUrl + "/user/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: username, password: password })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Wrong username or password");
                }
                return response.json();
            })
            .then(data => {
                document.getElementById("taskIdUser").value = data.id;
                document.getElementById("LoginUsername").textContent = data.username;
                getTasks();
                getBalance();
            })
            .catch(error => {
                document.getElementById("loginError").textContent = error.message;
            });
    }

    function getBalance() {
        const taskIdUser = document.getElementById("taskIdUser").value;
        fetch(apiUrl + "/user/balance/user?userId=" + taskIdUser)
            .then(response => response.json())
            .then(data => {
                console.log(data);
                document.getElementById("userBalance").textContent = data !== undefined ? data : "N/A";
            })
            .catch(error => console.error("Erro when try to search for balance:", error));
    }

    function createTask() {
        const taskName = document.getElementById("taskName").value;
        const taskIdUser = document.getElementById("taskIdUser").value;

        fetch(apiUrl + "/task/create", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ description: taskName, user_id: taskIdUser })
        })
            .then(response => {
                if (!response.ok) throw new Error("Erro when created task");
                return response.json();
            })
            .then(() => {
                document.getElementById("taskName").value = "";
                getTasks();
            })
            .catch(error => console.error(error));
    }

    function deleteTask(id) {
        fetch(apiUrl + `/task/delete/${id}`, { method: "DELETE" })
            .then(() => getTasks())
            .catch(error => console.error("Erro when delete task:", error));
    }

    function completedTask(id) {
        fetch(apiUrl + `/task/complete?id=${id}`, { method: "PUT" })
            .then(() => {
                getTasks();
                getBalance();
            })
            .catch(error => console.error("Error when completed task:", error));
    }

    function createUser() {
        const username = document.getElementById("create_username").value;
        const password = document.getElementById("create_password").value;
        fetch(apiUrl + "/user/create", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: username, password: password })
        })
            .then(response => {
                if (!response.ok) throw new Error("Erro when create user");
                return response.json();
            })
            .then(data => {
                document.getElementById("taskIdUser").value = data.id;
                document.getElementById("LoginUsername").textContent = data.username;
                getTasks();
                getBalance();
            });
    }
</script>
</body>
</html>
